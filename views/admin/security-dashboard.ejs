<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Dashboard - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header-footer.css">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/user-navbar.css">
    <link rel="stylesheet" href="/css/user-dashboard.css">
    <link rel="stylesheet" href="/css/dashboard-header.css">
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
</head>
<body class="admin-dashboard">
    <%- include('../partials/navbar') %>
    <%- include('../partials/admin-navbar') %>

    <div class="container py-4">
        <!-- Welcome Banner -->
        <div class="welcome-banner" data-aos="fade-up">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1>Security Dashboard üõ°Ô∏è</h1>
                    <p class="mb-0">Monitor and manage system security in real-time</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="current-time" id="currentTime"></div>
                    <div class="current-date" id="currentDate"></div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-card" data-aos="fade-up" data-aos-delay="100">
                <div class="stat-icon-wrapper">
                    <i class="fas fa-shield-alt stat-icon"></i>
                </div>
                <div class="stat-value"><%= stats.activeUsers %></div>
                <div class="stat-label">Active Users</div>
                <div class="stat-trend">
                    <i class="fas fa-user-shield"></i>
                    <span>Currently Online</span>
                </div>
            </div>

            <div class="stat-card" data-aos="fade-up" data-aos-delay="200">
                <div class="stat-icon-wrapper">
                    <i class="fas fa-exclamation-triangle stat-icon"></i>
                </div>
                <div class="stat-value"><%= stats.securityAlerts %></div>
                <div class="stat-label">Security Alerts</div>
                <div class="stat-trend">
                    <i class="fas fa-clock"></i>
                    <span>Last 24 hours</span>
                </div>
            </div>

            <div class="stat-card" data-aos="fade-up" data-aos-delay="300">
                <div class="stat-icon-wrapper">
                    <i class="fas fa-user-lock stat-icon"></i>
                </div>
                <div class="stat-value"><%= stats.failedLogins %></div>
                <div class="stat-label">Failed Logins</div>
                <div class="stat-trend">
                    <i class="fas fa-history"></i>
                    <span>Today</span>
                </div>
            </div>

            <div class="stat-card" data-aos="fade-up" data-aos-delay="400">
                <div class="stat-icon-wrapper">
                    <i class="fas fa-fingerprint stat-icon"></i>
                </div>
                <div class="stat-value"><%= stats.twoFactorEnabled %>%</div>
                <div class="stat-label">2FA Adoption</div>
                <div class="stat-trend">
                    <i class="fas fa-chart-line"></i>
                    <span>Of total users</span>
                </div>
            </div>
        </div>

        <!-- Security Charts -->
        <div class="dashboard-grid">
            <div class="dashboard-card" data-aos="fade-up" data-aos-delay="100">
                <div class="card-header">
                    <i class="fas fa-chart-line icon"></i>
                    <h3>Login Activity</h3>
                </div>
                <div class="card-body">
                    <canvas id="loginAttemptsChart"></canvas>
                </div>
            </div>

            <div class="dashboard-card" data-aos="fade-up" data-aos-delay="200">
                <div class="card-header">
                    <i class="fas fa-chart-pie icon"></i>
                    <h3>Security Incidents</h3>
                </div>
                <div class="card-body">
                    <canvas id="securityIncidentsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Audit Logs -->
        <div class="dashboard-card mt-4" data-aos="fade-up" data-aos-delay="300">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-clipboard-list icon"></i>
                        <h3>Audit Logs</h3>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="exportLogs()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Severity Level</label>
                        <select class="form-select" id="severityFilter">
                            <option value="">All Levels</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Event Type</label>
                        <select class="form-select" id="eventTypeFilter">
                            <option value="">All Events</option>
                            <option value="login">Login Attempts</option>
                            <option value="user">User Management</option>
                            <option value="system">System Changes</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date Range</label>
                        <input type="text" class="form-control date-range-picker" id="dateRange">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-2"></i>Apply
                        </button>
                    </div>
                </div>

                <!-- Logs -->
                <div class="audit-logs">
                    <% if (auditLogs.length > 0) { %>
                        <% auditLogs.forEach(function(log) { %>
                            <div class="audit-log-entry <%= log.severity %>" data-aos="fade-left">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1"><%= log.event %></h5>
                                        <p class="mb-1 text-muted"><%= log.description %></p>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            <%= new Date(log.timestamp).toLocaleString() %>
                                        </small>
                                    </div>
                                    <span class="badge rounded-pill severity-<%= log.severity %>">
                                        <%= log.severity.toUpperCase() %>
                                    </span>
                                </div>
                            </div>
                        <% }); %>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div class="text-muted">
                                Showing <%= (currentPage - 1) * 10 + 1 %> to 
                                <%= Math.min(currentPage * 10, totalLogs) %> of 
                                <%= totalLogs %> entries
                            </div>
                            <nav aria-label="Audit logs pagination">
                                <ul class="pagination mb-0">
                                    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                        <a class="page-link" href="?page=<%= currentPage - 1 %>" <%= currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : '' %>>
                                            Previous
                                        </a>
                                    </li>
                                    
                                    <% for(let i = 1; i <= totalPages; i++) { %>
                                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                            <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                                        </li>
                                    <% } %>
                                    
                                    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                        <a class="page-link" href="?page=<%= currentPage + 1 %>" <%= currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : '' %>>
                                            Next
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    <% } else { %>
                        <div class="empty-state" data-aos="fade-up">
                            <i class="fas fa-clipboard-list"></i>
                            <h4>No Audit Logs Found</h4>
                            <p class="text-muted">There are no audit logs to display at this time.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">

    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true
        });

        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Initialize date range picker
        $(document).ready(function() {
            $('.date-range-picker').daterangepicker({
                startDate: moment().subtract(7, 'days'),
                endDate: moment(),
                ranges: {
                    'Today': [moment(), moment()],
                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            });
        });

        // Login Attempts Chart
        const loginCtx = document.getElementById('loginAttemptsChart').getContext('2d');
        new Chart(loginCtx, {
            type: 'line',
            data: {
                labels: <%= JSON.stringify(charts.loginAttempts.labels) %>,
                datasets: [{
                    label: 'Successful Logins',
                    data: <%= JSON.stringify(charts.loginAttempts.successful) %>,
                    borderColor: '#48bb78',
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    fill: true
                }, {
                    label: 'Failed Logins',
                    data: <%= JSON.stringify(charts.loginAttempts.failed) %>,
                    borderColor: '#f56565',
                    backgroundColor: 'rgba(245, 101, 101, 0.1)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Security Incidents Chart
        const incidentsCtx = document.getElementById('securityIncidentsChart').getContext('2d');
        new Chart(incidentsCtx, {
            type: 'doughnut',
            data: {
                labels: <%= JSON.stringify(charts.securityIncidents.labels) %>,
                datasets: [{
                    data: <%= JSON.stringify(charts.securityIncidents.data) %>,
                    backgroundColor: [
                        '#f56565',
                        '#ed8936',
                        '#48bb78',
                        '#4299e1'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Filter functions
        function applyFilters() {
            const severity = document.getElementById('severityFilter').value;
            const eventType = document.getElementById('eventTypeFilter').value;
            const dateRange = document.getElementById('dateRange').value;
            
            const params = new URLSearchParams(window.location.search);
            if (severity) params.set('severity', severity);
            if (eventType) params.set('eventType', eventType);
            if (dateRange) params.set('dateRange', dateRange);
            
            window.location.href = `${window.location.pathname}?${params.toString()}`;
        }

        function exportLogs() {
            // Implement log export functionality
            alert('Export functionality will be implemented soon');
        }
    </script>
</body>
</html>
